<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>اختيار الفرع | Branch Picker</title>
  <style>
    :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --primary:#111827; --ring:rgba(17,24,39,.1) }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1120px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.7);border-bottom:1px solid var(--border)}
    .header-inner{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .logo{width:40px;height:40px;border-radius:16px;background:var(--primary);color:#fff;display:grid;place-items:center;font-weight:800}
    .title{margin:0;font-size:18px;font-weight:800}
    .subtitle{margin:2px 0 0;font-size:13px;color:var(--muted)}
    .spacer{margin-inline-start:auto}
    .search{width:100%;max-width:360px;border:1px solid var(--border);border-radius:16px;padding:10px 12px;font-size:14px;outline:none}
    .search:focus{box-shadow:0 0 0 6px var(--ring);border-color:transparent}
    main{padding:24px 16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 1px 2px rgba(0,0,0,.03);overflow:hidden;transition:box-shadow 120ms ease}
    .card:hover{box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .card-inner{padding:16px;display:grid;gap:12px}
    .row{display:flex;align-items:start;gap:12px}
    .avatar{width:40px;height:40px;border-radius:14px;background:#f3f4f6;display:grid;place-items:center;color:#374151;font-weight:700}
    .name{margin:0;font-size:16px;font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .addr{margin:4px 0 0;font-size:13px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .mapbox{border:1px solid var(--border);background:#f9fafb;border-radius:14px;padding:10px}
    .maprow{display:flex;align-items:center;gap:8px}
    .maprow a{font-size:14px;text-decoration:underline;text-underline-offset:4px;color:inherit}
    .tiny{font-size:11px;color:#9ca3af;margin:6px 0 0;word-break:break-all}
    .copy{margin-inline-start:auto;border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn{width:100%;padding:12px;border:0;border-radius:16px;cursor:pointer;background:var(--primary);color:#fff;font-weight:800;font-size:14px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:active{transform:scale(.99)}
    .empty{text-align:center;color:var(--muted);padding:64px 0}
    footer{text-align:center;color:#9ca3af;font-size:12px;margin-top:32px}
  </style>
</head>
<body>
  <header>
    <div class="header-inner container">
      <div class="logo" aria-hidden>ف</div>
      <div>
        <p class="title">اختر الفرع</p>
        <p class="subtitle">اضغط “اختر الفرع” لإرساله إلى البوت.</p>
      </div>
      <div class="spacer"></div>
      <input id="search" class="search" placeholder="ابحث بالاسم أو العنوان…" />
    </div>
  </header>

  <main class="container">
    <div id="grid" class="grid" role="list"></div>
    <div id="empty" class="empty" hidden>لا توجد فروع مطابقة لبحثك.</div>
    <footer>تلميح: عدّل قائمة الفروع داخل الكود في المتغيّر <b>branchesData</b>.</footer>
  </main>

  <!-- سكربت تيليجرام WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    "use strict";

    // ✅ عنوان الويب هوك (Production)
    const WEBHOOK_URL = 'https://saif918.app.n8n.cloud/webhook/tg-webapp-branch';

    // نقرأ chat_id من الكويكويري
    const params  = new URLSearchParams(location.search);
    const chat_id = params.get("chat_id") || "";

    // بيانات الفروع (مثال)
    const branchesData = [
      { id: "b1",  name: "فرع البوادي",       address: "تبوك",          mapUrl: "https://maps.app.goo.gl/ok8mgPdmxfN8pNeG6?g_st=ipc" },
      { id: "b2",  name: "فرع الدخل",         address: "تبوك",          mapUrl: "https://maps.app.goo.gl/uf6svqt4BAbr4NCWA?g_st=ipc" },
      { id: "b3",  name: "فرع العزيزية",      address: "العلا",          mapUrl: "https://maps.app.goo.gl/P9e5fRy2TiZU8fsU9?g_st=ipc" },
      { id: "b4",  name: "فرع القادسية",      address: "تبوك",          mapUrl: "https://maps.app.goo.gl/NYY7iczMB2GUBZ7C6?g_st=ipc" },
      { id: "b5",  name: "فرع مروج الامير",   address: "تبوك",          mapUrl: "https://maps.app.goo.gl/e2ndY2o7ncy8yKz86?g_st=ipc" },
      { id: "b6",  name: "فرع العليا",        address: "تبوك",          mapUrl: "https://maps.app.goo.gl/Jv5ExJASvhqi3p877?g_st=ipc" },
      { id: "b7",  name: "فرع الصخيرات",      address: "العلا",          mapUrl: "https://maps.app.goo.gl/P9e5fRy2TiZU8fsU9?g_st=ipc" },
      { id: "b8",  name: "فرع تيماء",         address: "تيماء",         mapUrl: "https://maps.app.goo.gl/JShhnKJeyp6sYtxx5?g_st=ipc" },
      { id: "b9",  name: "فرع دومة الجندل",   address: "دومة الجندل",   mapUrl: "https://maps.app.goo.gl/bwdFSNzvxrUY5rN8A?g_st=ipc" },
      { id: "b10", name: "فرع الوجه",         address: "الوجه",         mapUrl: "https://maps.app.goo.gl/hNsyAr5GYmsDrpKu6?g_st=ipc" },
      { id: "b11", name: "فرع ضباء",          address: "ضباء",          mapUrl: "https://maps.app.goo.gl/J7dzea1o665zdjNG8?g_st=ipc" }
    ];

    // DOM
    const gridEl   = document.getElementById("grid");
    const emptyEl  = document.getElementById("empty");
    const searchEl = document.getElementById("search");

    // Telegram WebApp
    const tg = window.Telegram?.WebApp || null;
    if (tg) { try { tg.expand(); tg.MainButton?.hide(); } catch(_) {} }

    // إرسال الويبهوك
    async function sendBranchToBot(branch, buttonEl){
      if (!chat_id) {
        tg?.showAlert?.('المعرّف chat_id غير موجود في رابط الصفحة ❌');
        return;
      }
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 15000); // 15s

      const payload = {
        chat_id,
        type: 'branch_selected',
        branch: { id: branch.id, name: branch.name, address: branch.address, mapUrl: branch.mapUrl },
        source: 'webapp'
      };

      try {
        buttonEl.disabled = true;
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors',
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeout);

        if (!res.ok) throw new Error('Webhook responded with status ' + res.status);

        try { tg?.HapticFeedback?.notificationOccurred?.("success"); } catch{}
        tg?.showAlert?.('تم إرسال الفرع للبوت ✅');
        tg?.close?.();
      } catch (err) {
        console.error(err);
        try { tg?.HapticFeedback?.notificationOccurred?.("error"); } catch{}
        tg?.showAlert?.('تعذر الإرسال، حاول مرة أخرى ❌');
      } finally {
        buttonEl.disabled = false;
      }
    }

    function render(list) {
      gridEl.innerHTML = "";
      if (!list || !list.length) { emptyEl.hidden = false; return; }
      emptyEl.hidden = true;

      for (const b of list) {
        const card  = document.createElement("article"); card.className = "card";
        const inner = document.createElement("div");     inner.className = "card-inner";

        const row   = document.createElement("div"); row.className = "row";
        const avatar= document.createElement("div"); avatar.className = "avatar"; avatar.textContent = (b.name||"").slice(0,2);
        const meta  = document.createElement("div");
        const h2    = document.createElement("h2"); h2.className="name"; h2.textContent = b.name || "فرع";
        const addr  = document.createElement("p");  addr.className="addr"; addr.textContent = b.address || "";
        meta.appendChild(h2); if (b.address) meta.appendChild(addr);
        row.appendChild(avatar); row.appendChild(meta);

        let mapBox = null;
        if (b.mapUrl) {
          mapBox = document.createElement("div"); mapBox.className = "mapbox";
          const maprow = document.createElement("div"); maprow.className = "maprow";
          const link = document.createElement("a");
          link.href = b.mapUrl; link.target="_blank"; link.rel="noopener noreferrer"; link.textContent = "رابط موقع الفرع على الخريطة";
          const copyBtn = document.createElement("button"); copyBtn.className="copy"; copyBtn.type="button"; copyBtn.textContent="نسخ الرابط";
          copyBtn.addEventListener("click", async () => {
            try { await navigator.clipboard.writeText(b.mapUrl); copyBtn.textContent="✓ تم النسخ"; setTimeout(()=>copyBtn.textContent="نسخ الرابط",1500);} catch {}
          });
          maprow.appendChild(link); maprow.appendChild(copyBtn);
          const tiny = document.createElement("p"); tiny.className="tiny"; tiny.textContent = b.mapUrl;
          mapBox.appendChild(maprow); mapBox.appendChild(tiny);
        }

        const selectBtn = document.createElement("button");
        selectBtn.className = "btn"; selectBtn.type = "button"; selectBtn.textContent = "اختر الفرع";
        selectBtn.addEventListener("click", () => sendBranchToBot(b, selectBtn));

        inner.appendChild(row);
        if (mapBox) inner.appendChild(mapBox);
        inner.appendChild(selectBtn);
        card.appendChild(inner);
        gridEl.appendChild(card);
      }
    }

    function filterList(q) {
      const query = (q||"").trim().toLowerCase();
      if (!query) return branchesData;
      return branchesData.filter(b =>
        [b.name, b.address].filter(Boolean).some(v => String(v).toLowerCase().includes(query))
      );
    }

    searchEl.addEventListener("input", e => render(filterList(e.target.value)));
    render(branchesData);
  </script>
</body>
</html>
